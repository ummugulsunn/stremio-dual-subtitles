/**
 * HTML templates for various pages
 */

// Helper function to format time ago
function formatTimeAgo(timestamp) {
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'Just now';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
  if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
  return Math.floor(seconds / 86400) + 'd ago';
}

function generateStatsHTML(stats, baseUrl, manifest) {
  // Pre-generate chart bars
  const maxVal = Math.max(...stats.hourlyChart.map(x => x.pageViews || 1), 1);
  const chartBars = stats.hourlyChart.map(h => {
    const height = ((h.pageViews || 0) / maxVal) * 100;
    return '<div class="chart-bar" style="height: ' + Math.max(height, 2) + '%" data-value="' + (h.pageViews || 0) + '"></div>';
  }).join('');

  // Pre-generate language lists
  const topLanguagesHTML = stats.topLanguages.length > 0 
    ? stats.topLanguages.map(function(item, i) {
        return '<div class="language-item"><div class="language-rank">' + (i + 1) + '</div><div class="language-name">' + item[0] + '</div><div class="language-count">' + item[1] + '</div></div>';
      }).join('')
    : '<div class="empty-state">No data yet</div>';

  const topPairsHTML = stats.topPairs.length > 0
    ? stats.topPairs.map(function(item, i) {
        return '<div class="language-item"><div class="language-rank">' + (i + 1) + '</div><div class="language-name">' + item[0] + '</div><div class="language-count">' + item[1] + '</div></div>';
      }).join('')
    : '<div class="empty-state">No data yet</div>';

  // Pre-generate activity list
  const activityHTML = stats.recentActivity.length > 0
    ? stats.recentActivity.map(function(activity) {
        const icons = { pageView: 'üëÅÔ∏è', install: '‚¨áÔ∏è', subtitleRequest: 'üé¨' };
        let title = 'Page View';
        if (activity.type === 'install') {
          const mainLang = activity.details.mainLang ? activity.details.mainLang.split(' ')[0] : '';
          const transLang = activity.details.transLang ? activity.details.transLang.split(' ')[0] : '';
          title = 'Install: ' + mainLang + ' + ' + transLang;
        } else if (activity.type === 'subtitleRequest') {
          title = 'Subtitle: ' + (activity.details.contentType || 'content');
        }
        const timeAgo = formatTimeAgo(activity.timestamp);
        const icon = icons[activity.type] || 'üìå';
        return '<div class="activity-item"><div class="activity-icon ' + activity.type + '">' + icon + '</div><div class="activity-content"><div class="activity-title">' + title + '</div><div class="activity-time">' + timeAgo + '</div></div></div>';
      }).join('')
    : '<div class="empty-state">No recent activity</div>';

  return '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Analytics - ' + manifest.name + '</title>\n  <link rel="icon" type="image/png" href="' + manifest.logo + '">\n  <link rel="preconnect" href="https://fonts.googleapis.com">\n  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    :root {\n      --primary: #667eea;\n      --secondary: #764ba2;\n      --bg-dark: #0f0f1a;\n      --bg-card: rgba(255, 255, 255, 0.03);\n      --text: #ffffff;\n      --text-muted: rgba(255, 255, 255, 0.6);\n      --border: rgba(255, 255, 255, 0.08);\n      --success: #10b981;\n      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);\n    }\n    body { font-family: "Inter", sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }\n    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }\n    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }\n    .header-left { display: flex; align-items: center; gap: 16px; }\n    .header-left img { width: 48px; height: 48px; border-radius: 12px; }\n    .header-left h1 { font-size: 24px; font-weight: 700; }\n    .header-left p { font-size: 14px; color: var(--text-muted); }\n    .back-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); text-decoration: none; font-size: 14px; }\n    .back-btn:hover { background: rgba(255, 255, 255, 0.08); }\n    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }\n    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }\n    .stat-card.highlight { background: var(--gradient); border: none; }\n    .stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }\n    .stat-card.highlight .stat-label { color: rgba(255, 255, 255, 0.8); }\n    .stat-value { font-size: 32px; font-weight: 800; }\n    .stat-change { font-size: 12px; color: var(--success); margin-top: 4px; }\n    .section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }\n    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }\n    .chart-container { height: 200px; display: flex; align-items: flex-end; gap: 4px; padding: 20px 0; }\n    .chart-bar { flex: 1; background: var(--gradient); border-radius: 4px 4px 0 0; min-height: 4px; }\n    .chart-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); padding-top: 8px; border-top: 1px solid var(--border); }\n    .language-list { display: grid; gap: 12px; }\n    .language-item { display: flex; align-items: center; gap: 12px; }\n    .language-rank { width: 28px; height: 28px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }\n    .language-name { flex: 1; font-size: 14px; }\n    .language-count { font-size: 14px; font-weight: 600; color: var(--primary); }\n    .activity-list { display: grid; gap: 12px; max-height: 400px; overflow-y: auto; }\n    .activity-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; }\n    .activity-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }\n    .activity-icon.pageView { background: rgba(102, 126, 234, 0.2); }\n    .activity-icon.install { background: rgba(16, 185, 129, 0.2); }\n    .activity-icon.subtitleRequest { background: rgba(245, 158, 11, 0.2); }\n    .activity-content { flex: 1; }\n    .activity-title { font-size: 13px; font-weight: 500; }\n    .activity-time { font-size: 11px; color: var(--text-muted); }\n    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }\n    .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }\n    .uptime-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 20px; font-size: 12px; color: var(--success); }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <div class="header">\n      <div class="header-left">\n        <img src="' + manifest.logo + '" alt="Logo">\n        <div>\n          <h1>Analytics Dashboard</h1>\n          <p>Real-time addon usage statistics</p>\n        </div>\n      </div>\n      <div style="display: flex; gap: 12px; align-items: center;">\n        <span class="uptime-badge">Online ‚Ä¢ ' + stats.overview.uptime + '</span>\n        <a href="' + baseUrl + '/configure" class="back-btn">‚Üê Back to Addon</a>\n      </div>\n    </div>\n    <div class="stats-grid">\n      <div class="stat-card highlight">\n        <div class="stat-label">Total Page Views</div>\n        <div class="stat-value">' + stats.overview.totalPageViews.toLocaleString() + '</div>\n        <div class="stat-change">Today: ' + stats.today.pageViews + '</div>\n      </div>\n      <div class="stat-card">\n        <div class="stat-label">Addon Installs</div>\n        <div class="stat-value">' + stats.overview.totalInstalls.toLocaleString() + '</div>\n        <div class="stat-change">Today: ' + stats.today.installs + '</div>\n      </div>\n      <div class="stat-card">\n        <div class="stat-label">Subtitle Requests</div>\n        <div class="stat-value">' + stats.overview.totalSubtitleRequests.toLocaleString() + '</div>\n        <div class="stat-change">Today: ' + stats.today.subtitleRequests + '</div>\n      </div>\n      <div class="stat-card">\n        <div class="stat-label">Unique Visitors</div>\n        <div class="stat-value">' + stats.overview.uniqueVisitors.toLocaleString() + '</div>\n      </div>\n    </div>\n    <div class="section">\n      <div class="section-title">üìä Hourly Activity (Last 24 Hours)</div>\n      <div class="chart-container">' + chartBars + '</div>\n      <div class="chart-labels"><span>24h ago</span><span>12h ago</span><span>Now</span></div>\n    </div>\n    <div class="grid-2">\n      <div class="section">\n        <div class="section-title">üåç Top Languages</div>\n        <div class="language-list">' + topLanguagesHTML + '</div>\n      </div>\n      <div class="section">\n        <div class="section-title">üë• Top Language Pairs</div>\n        <div class="language-list">' + topPairsHTML + '</div>\n      </div>\n    </div>\n    <div class="section">\n      <div class="section-title">‚ö° Recent Activity</div>\n      <div class="activity-list">' + activityHTML + '</div>\n    </div>\n  </div>\n  <script>setTimeout(function() { location.reload(); }, 30000);</script>\n</body>\n</html>';
}

function generatePrivacyHTML(baseUrl, manifest) {
  return '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Privacy Policy - ' + manifest.name + '</title>\n  <link rel="icon" type="image/png" href="' + manifest.logo + '">\n  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: "Inter", sans-serif; background: #0f0f1a; color: #fff; line-height: 1.8; }\n    .container { max-width: 800px; margin: 0 auto; padding: 60px 20px; }\n    .back-link { display: inline-flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.6); text-decoration: none; font-size: 14px; margin-bottom: 40px; }\n    .back-link:hover { color: #fff; }\n    h1 { font-size: 36px; margin-bottom: 16px; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }\n    .updated { font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 40px; }\n    h2 { font-size: 22px; margin: 40px 0 16px; color: #a5b4fc; }\n    p, ul { color: rgba(255,255,255,0.8); margin-bottom: 16px; }\n    ul { padding-left: 24px; }\n    li { margin-bottom: 8px; }\n    .highlight { background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; padding: 16px 20px; border-radius: 0 8px 8px 0; margin: 24px 0; }\n    a { color: #667eea; }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <a href="' + baseUrl + '/configure" class="back-link">‚Üê Back to Addon</a>\n    <h1>Privacy Policy</h1>\n    <p class="updated">Last updated: February 2026</p>\n    <div class="highlight"><strong>TL;DR:</strong> We don\'t collect personal data. We don\'t track you. We don\'t sell anything. Your privacy is respected.</div>\n    <h2>What We Collect</h2>\n    <p>We collect minimal, anonymous data solely for improving the service:</p>\n    <ul>\n      <li><strong>Anonymous usage statistics:</strong> Page views, install counts, and language preferences (no personal identifiers)</li>\n      <li><strong>Hashed IP addresses:</strong> Used only for counting unique visitors, not stored in identifiable form</li>\n      <li><strong>Error logs:</strong> Technical errors for debugging, automatically deleted</li>\n    </ul>\n    <h2>What We Don\'t Collect</h2>\n    <ul>\n      <li>Personal information (name, email, etc.)</li>\n      <li>Viewing history or what you watch</li>\n      <li>Device information beyond basic stats</li>\n      <li>Cookies for tracking purposes</li>\n    </ul>\n    <h2>Third-Party Services</h2>\n    <p>We use:</p>\n    <ul>\n      <li><strong>OpenSubtitles:</strong> For fetching subtitles. Their privacy policy applies to their service.</li>\n      <li><strong>Vercel:</strong> For hosting. Standard server logs may be collected by the hosting provider.</li>\n    </ul>\n    <h2>Data Storage</h2>\n    <p>All analytics data is stored in memory and resets when the server restarts. No persistent database of user activity is maintained.</p>\n    <h2>Your Rights</h2>\n    <p>Since we don\'t collect personal data, there\'s nothing to delete or export. You can use the addon completely anonymously.</p>\n    <h2>Open Source</h2>\n    <p>This addon is open source. You can verify our privacy practices by reviewing the code on <a href="https://github.com/ummugulsunn/stremio-dual-subtitles">GitHub</a>.</p>\n    <h2>Contact</h2>\n    <p>Questions? Open an issue on our GitHub repository.</p>\n  </div>\n</body>\n</html>';
}

function generateErrorHTML(code, message, baseUrl, manifest) {
  const titles = { 401: 'Unauthorized', 404: 'Page Not Found', 500: 'Server Error', 429: 'Too Many Requests' };
  const descriptions = {
    401: "You need a valid access key to view this page.",
    404: "The page you're looking for doesn't exist or has been moved.",
    500: "Something went wrong on our end. Please try again later.",
    429: "You've made too many requests. Please wait a moment and try again."
  };
  
  return '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>' + code + ' - ' + (titles[code] || 'Error') + '</title>\n  <link rel="icon" type="image/png" href="' + manifest.logo + '">\n  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: "Inter", sans-serif; background: #0f0f1a; color: #fff; min-height: 100vh; display: flex; align-items: center; justify-content: center; }\n    .container { text-align: center; padding: 40px 20px; }\n    .code { font-size: 120px; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }\n    h1 { font-size: 28px; margin: 20px 0 12px; }\n    p { color: rgba(255,255,255,0.6); font-size: 16px; margin-bottom: 32px; }\n    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 14px 28px; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; text-decoration: none; border-radius: 12px; font-weight: 600; }\n    .btn:hover { transform: translateY(-2px); }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <div class="code">' + code + '</div>\n    <h1>' + (titles[code] || 'Error') + '</h1>\n    <p>' + (descriptions[code] || message) + '</p>\n    <a href="' + baseUrl + '/configure" class="btn">‚Üê Back to Home</a>\n  </div>\n</body>\n</html>';
}

module.exports = {
  generateStatsHTML,
  generatePrivacyHTML,
  generateErrorHTML
};
